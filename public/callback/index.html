<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display code</title>
</head>
<body>
    <p><b>Code=</b><span id="code"></span></p>
    <p><b>State=</b><span id="state"></span></p>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qs/6.10.1/qs.min.js
    "></script>
    <script>
        const qs = window.Qs

        const codeSlot = document.getElementById('code')
        const stateSlot = document.getElementById('state')

        const code = qs.parse(window.location.search, { ignoreQueryPrefix: true }).code
        const state = qs.parse(window.location.search, { ignoreQueryPrefix: true }).state

        codeSlot.appendChild(document.createTextNode(code))
        stateSlot.appendChild(document.createTextNode(state))

        // localStorage.setItem('code', code)
        // localStorage.setItem('state', state)

        window.addEventListener("load", () => {
        
            function sendData() {
                const url = 'http://localhost:3031/api/v1'
                + '/auth/token?'
                + 'grant_type=authorization_code'
                + '&code=' + code
                + '&client_id=1234ABCD'
                + '&redirect_uri=http://192.168.1.38:3000/callback'
                + '&state=' + state

                const requestOptions = {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'WWW-Authenticate': 'Basic realm="hitzii-client"',
                        'Authorization': 'Basic MTIzNEFCQ0Q6NyNZX2Y0VDhlUi5EcjNAbk41Pw=='
                    }
                }

                try {
                    fetch(url, requestOptions).then(response => {
                        const data = response.json().then(res => {
                            console.log('Fulfilled response is %o', res)
                            const { user, token, warning } = res
                            localStorage.setItem('token', JSON.stringify(token))
                            localStorage.setItem('user', JSON.stringify(user))
                            if (warning) {
                                localStorage.setItem('warning', JSON.stringify(warning))
                            }
                        })
                    })
                } catch (error) {
                    console.error(error)
                }
            }

            sendData()
        })
    </script>
</body>
</html>